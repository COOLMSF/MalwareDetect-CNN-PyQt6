from __future__ import print_function
from virus_total_apis import PublicApi as VirusTotalPublicApi
import sys, os, time
import re, json
import zipfile, hashlib

# check if is an IPv4 address
def is_ip(ip):
    regex = "^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])$"
    if(re.search(regex, ip)):
        return True

# determine if delete the malware file
def is_clean_file(filename):
    print("Malware detected, delete it? 1)yes, 2) no, 3) quit")

    while True:
        user_input = input("your choice:")
        if user_input == "1":
            print("delete succeed")
            os.remove(sys.argv[1])
            break
        elif  user_input == "2":
            print("keep malware")
            break
        elif user_input == "3":
            break
        else:
            continue


# main function
def main():
    # get current time
    current_time = time.strftime("%d%m%Y%H%M%S")
    # get current dir
    current_dir = os.path.dirname(os.path.abspath(__file__))
    # virustotal API
    virustotal = VirusTotalPublicApi('b18dc7be4b9979a9d695c6ba579628623f0930c567a36d9c0a664a8d9c946d89')

    # open source file
    file_fd = open("source.txt")
    lines = file_fd.readlines()
    print("scanning...\n\n")

    # unzip theme
    zip_file_name = 'theme'
    zip_core = zipfile.ZipFile(zip_file_name)
    zip_core.extractall(r'.')

    # report file name
    report_file=current_dir+"/Report_"+current_time+".html"
    myFile= open(report_file, 'w+')

    # template
    html_baslangic = """
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Analysis report</title>
        <link rel="stylesheet" href="theme_scripts/bootstrap.css">
        <link rel="stylesheet" href="theme_scripts/dataTables.bootstrap4.min.css">
        <link rel="stylesheet" href="theme_scripts/buttons.bootstrap4.min.css">
        <link rel="stylesheet" href="theme_scripts/responsive.bootstrap4.min.css">
    </head>
    <body>
    <br><b><center style="font-size: 33px;">Analysis report</center></b><br>
    <style>

    .footer {
      position: fixed;
      left: 0;
      bottom: 0;
      width: 90%;
      background-color: #42A5F5;
      color: white;
      text-align: center;
    }
    </style>
        <table id="example" class="table table-striped table-bordered dt-responsive nowrap" style="width:100%">

     <thead>
                <tr>
                    <th>Type</th>

                    <th>AV0</th>

                    <th>AV1</th>

                    <th>AV2</th>

                    <th>AV3</th>

                    <th>timeline</th>

                    <th>url</th>
                </tr>
            </thead>
    <tbody>
                <tr><td>


    """

    sayac=0

    myFile.write(html_baslangic)

    # for every element
    for line in lines:

        ip_true=0
        hash_true=0
        Domain_true=0
        
        if is_ip(line):
            # get report
            ip_check= virustotal.get_ip_report(str(line).replace("\n",""))

            # serialize the data
            json_data = json.loads(json.dumps(ip_check))
            data=str(line).replace("\n","")
            type_url=data
            ip_true=1
            time.sleep(15)

        # is md5
        validHash_MD5 = re.finditer(r'(?=(\b[A-Fa-f0-9]{32}\b))', line)
        MD5_check = [match.group(1) for match in validHash_MD5]
        if MD5_check:
            hash_type_report="MD5"

        # is sha1
        validHash_SHA1 = re.finditer(r'(?=(\b[0-9a-f]{40}\b))', line)
        SHA1_check = [match.group(1) for match in validHash_SHA1]
        if SHA1_check:
            hash_type_report="SHA1"

        # is sha256
        validHash_SHA256 = re.finditer(r'(?=(\b[A-Fa-f0-9]{64}\b))', line)
        SHA256_check = [match.group(1) for match in validHash_SHA256]
        if SHA256_check:
            hash_type_report="SHA256"

        if MD5_check or SHA1_check or SHA256_check:
            # get file report
            hash_check = virustotal.get_file_report(line)
            json_data = json.loads(json.dumps(hash_check))
            data=str(line).replace("\n","")
            type_url=data
            hash_true=1
            time.sleep(15)

        

        sayac+=1



        # network error
        if str(json_data['response_code'])=='204':
            print(" \n Error connection to Virustotal.")
            break
        else:
            try:
                if hash_true==1:
                    if json_data['results']['response_code'] == 1 and json_data['results']['positives']>0:

                                # write template
                                myFile.write(hash_type_report+'</td><td>')
                                myFile.write(data)
                                myFile.write('</td><td>')
                                if 'Kaspersky' in json_data['results']['scans']:
                                    myFile.write(str(json_data['results']['scans']['Kaspersky']['result']))
                                else:
                                    myFile.write("Hash Not Found!")

                                myFile.write('</td><td>')
                                if 'Symantec' in json_data['results']['scans']:
                                     myFile.write(str(json_data['results']['scans']['Symantec']['result']))
                                else:
                                    myFile.write("Hash Not Found!")
                                myFile.write('</td><td>')
                                myFile.write(str(json_data['results']['positives']))
                                print("[", sayac, "]", data, " Detected. Skor: [ ",str(json_data['results']['positives'])," ]")
                                is_clean_file(sys.argv[1])
                                myFile.write('</td><td>')
                                myFile.write(json_data['results']['scan_date'])
                                myFile.write('</td><td>')
                                myFile.write(' <a href="https://www.virustotal.com/gui/file/%s/details" target="_blank"> <button class ="btn btn-secondary buttons-pdf buttons-html5" tabindex="0" aria-controls="example" type="button" > <span>Click</span> </button> </a>' % type_url)
                                myFile.write('</td></tr><tr><td>')

                    elif json_data['results']['response_code'] == 1 and json_data['results']['positives'] == 0:
                        
                        try:
                            myFile.write(hash_type_report+'</td><td>')
                            myFile.write(data)
                            myFile.write('</td><td>N/A</td><td>N/A</td><td>0</td><td>'+json_data['results']['scan_date']+'</td><td>')
                            myFile.write(' <a href="https://www.virustotal.com/gui/file/%s/details" target="_blank"> <button class ="btn btn-secondary buttons-pdf buttons-html5" tabindex="0" aria-controls="example" type="button" > <span>Click</span> </button> </a>' % type_url)
                            myFile.write('</td></tr><tr><td>')
                        except:
                            pass
                    else:
                        try:
                            myFile.write(hash_type_report+'</td><td>')
                            myFile.write(data)
                            myFile.write('</td><td>Hash Not Found!</td><td>Hash Not Found!</td><td>N/A</td><td>N/A</td><td>N/A</td></tr><tr><td>')
                        except:
                            pass

                
                elif ip_true==1:

                    if str(json_data['results']['detected_urls']) =="[]":

                            myFile.write("IPv4</td><td>")                        
                            myFile.write(data)
                            myFile.write('</td><td>--</td><td>--</td><td>0</td><td>--</td><td>')
                            myFile.write(' <a href="https://www.virustotal.com/gui/ip-address/%s/details" target="_blank"> <button class ="btn btn-secondary buttons-pdf buttons-html5" tabindex="0" aria-controls="example" type="button" > <span>Click</span> </button> </a>' % type_url)
                            myFile.write('</td></tr><tr><td>')
                            pass

                    elif json_data['results']['response_code'] == 1 and json_data['results']['detected_urls'][0]['positives']>0:

                                myFile.write("IPv4</td><td>")
                                myFile.write(data)
                                myFile.write('</td><td>--</td><td>--</td><td>'+str(json_data['results']['detected_urls'][0]['positives'])+"</td><td>"+json_data['results']['detected_urls'][0]['scan_date']+"</td><td>")
                                print("[", sayac, "]", data, " Detected. Skor: [ ",str(json_data['results']['detected_urls'][0]['positives'])," ]")


                                myFile.write(' <a href="https://www.virustotal.com/gui/ip-address/%s/details" target="_blank"> <button class ="btn btn-secondary buttons-pdf buttons-html5" tabindex="0" aria-controls="example" type="button" > <span>Click</span> </button> </a>' % type_url)
                                myFile.write('</td></tr><tr><td>')

                elif Domain_true==1:
                    
                    
                    if json_data['results']['response_code'] ==0:
                        myFile.write("URL</td><td>")                        
                        myFile.write(data)
                        myFile.write('</td><td>--</td><td>--</td><td>Domain Not Found!</td><td>--</td><td>')
                        myFile.write('N/A')
                        myFile.write('</td></tr><tr><td>')
                        pass

                    elif json_data['results']['response_code'] == 1 and json_data['results']['positives'] == 0:

                        myFile.write("URL</td><td>")                        
                        myFile.write(data)
                        myFile.write('</td><td>--</td><td>--</td><td>0</td><td>'+json_data['results']['scan_date']+'</td><td>')
                        myFile.write(' <a href="%s" target="_blank"> <button class ="btn btn-secondary buttons-pdf buttons-html5" tabindex="0" aria-controls="example" type="button" > <span>Click</span> </button> </a>' % json_data['results']['permalink'])
                        myFile.write('</td></tr><tr><td>')

                    elif json_data['results']['response_code'] == 1 and json_data['results']['positives']>0:

                        myFile.write("URL</td><td>")
                        myFile.write(data)
                        myFile.write('</td><td>--</td><td>--</td><td>'+str(json_data['results']['positives'])+"</td><td>"+json_data['results']['scan_date']+"</td><td>")
                        print("[", sayac, "]", data, " Detected. Skor: [ ",str(json_data['results']['positives'])," ]")
                        myFile.write(' <a href="%s" target="_blank"> <button class ="btn btn-secondary buttons-pdf buttons-html5" tabindex="0" aria-controls="example" type="button" > <span>Click</span> </button> </a>' % json_data['results']['permalink'])
                        myFile.write('</td></tr><tr><td>')



                hash_type_report=""

                
            except:
                pass

    file_fd.close()
    if str(json_data['response_code'])!='204':
        print("\n Success file located at: ", report_file," ")
    html_bitir = """
    </td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
     </tbody>
        </table>
    <br><br><br><div class="footer">
      <p>></p>
    </div>

    <script src="theme_scripts/jquery-3.3.1.js"></script>
        <script src="theme_scripts/jquery.dataTables.min.js"></script>
        <script src="theme_scripts/dataTables.bootstrap4.min.js"></script>
        <script src="theme_scripts/dataTables.buttons.min.js"></script>
        <script src="theme_scripts/buttons.bootstrap4.min.js"></script>
        <script src="theme_scripts/jszip.min.js"></script>
        <script src="theme_scripts/pdfmake.min.js"></script>
        <script src="theme_scripts/vfs_fonts.js"></script>
        <script src="theme_scripts/buttons.html5.min.js"></script>
        <script src="theme_scripts/buttons.print.min.js"></script>
        <script src="theme_scripts/buttons.colVis.min.js"></script>
        <script src="theme_scripts/dataTables.responsive.min.js"></script>
        <script src="theme_scripts/responsive.bootstrap4.min.js"></script>
        <script>
        $(document).ready(function() {
            var table = $('#example').DataTable( {
                lengthChange: false,
                buttons: [ 'copy', 'excel', 'csv', 'pdf', 'colvis' ]
            } );
         
            table.buttons().container()
                .appendTo( '#example_wrapper .col-md-6:eq(0)' );
        } );
         </script>
    </body>
    </html>
     """
    myFile.write(html_bitir)


def virus_total_detect(filename):
    os.chdir('/home/coolder/data/Learning/AI/DL/MalwareDetect/code/virustotal')
    # check number of argument
    binary_data = None
    # open binary file
    with open(filename, "rb") as binary_fd:
        binary_data = binary_fd.read()

    # make md5
    md5 = hashlib.md5(binary_data).hexdigest()

    with open("source.txt", "w") as f:
        # write md5 to source.txt
        f.writelines(md5)
    main()
